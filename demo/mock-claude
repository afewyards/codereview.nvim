#!/bin/sh
# Mock Claude CLI for demo/showcase purposes.
# Usage: echo "<prompt>" | ./demo/mock-claude
#
# Reads stdin (discards it), simulates AI processing delay, then outputs
# canned code review suggestions in the format expected by codereview.nvim.
#
# Suggestions target + lines in the demo provider diffs (PR #42):
#   src/utils/token.ts         L5  (error)      — module-level throw
#   src/middleware/auth.ts     L5  (warning)     — silent header fallback
#   src/utils/token.ts         L23 (suggestion)  — unsafe cast
#   tests/middleware/auth.test.ts L16 (info)     — missing mock

cat > /dev/null

sleep 3

cat <<'RESPONSE'
I've reviewed the changes in this merge request. Here are my findings:

```json
[
  {
    "file": "src/utils/token.ts",
    "line": 5,
    "code": "if (!SECRET) {",
    "severity": "error",
    "comment": "Module-level throw breaks test isolation.\n\nIf `JWT_SECRET` is not set when this module is first imported, Node throws immediately — crashing every test suite that imports anything depending on this file, even tests unrelated to auth.\n\nConsider lazy validation inside `verifyToken` instead, or export a separate `validateConfig()` function called at app startup."
  },
  {
    "file": "src/middleware/auth.ts",
    "line": 5,
    "code": "const token = extractTokenFromHeader(req.headers.authorization);",
    "severity": "warning",
    "comment": "Bearer scheme check is case-sensitive.\n\n`extractTokenFromHeader` splits on `' '` and compares the scheme with `=== 'Bearer'` (exact case). The HTTP spec (RFC 7235) treats scheme names as case-insensitive, so clients sending `bearer` or `BEARER` will receive a 401 despite having a valid token.\n\nFix: normalise before comparing:\n  return scheme.toLowerCase() === 'bearer' ? token : null;"
  },
  {
    "file": "src/utils/token.ts",
    "line": 23,
    "code": "const payload = jwt.verify(token, SECRET!) as jwt.JwtPayload;",
    "severity": "suggestion",
    "comment": "Consider allowing clock tolerance for token verification.\n\n`jwt.verify` with no options uses a zero-second clock tolerance, which means tokens can be rejected if the issuer's clock is even slightly ahead of the server's clock.\n\nConsider adding a small tolerance:\n  jwt.verify(token, SECRET!, { clockTolerance: 30 })"
  },
  {
    "file": "tests/middleware/auth.test.ts",
    "line": 16,
    "code": "it('calls next with valid token', async () => {",
    "severity": "info",
    "comment": "Consider adding more test cases for the happy path.\n\nThis test only covers a single valid-token scenario. Consider adding cases for:\n- Expired tokens (should return 403)\n- Tokens with missing `sub` claim\n- Tokens signed with a different secret\n\nMore granular cases will make regressions easier to diagnose."
  }
]
```
RESPONSE
