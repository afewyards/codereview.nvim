name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: go-semantic-release/action@v1
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  demo-gifs:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ needs.release.outputs.version != '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - uses: charmbracelet/vhs-action@v2
        with:
          path: demo/showcase.tape

      - uses: charmbracelet/vhs-action@v2
        with:
          path: demo/ai-review.tape

      - name: Upload demo assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "v${{ needs.release.outputs.version }}" \
            demo/showcase.gif demo/showcase.mp4 \
            demo/ai-review.gif demo/ai-review.mp4 \
            --clobber

  # Uncomment when ready to publish to LuaRocks:
  #
  # luarocks:
  #   needs: release
  #   runs-on: ubuntu-latest
  #   if: ${{ needs.release.outputs.version != '' }}
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - uses: leafo/gh-actions-lua@v10
  #       with:
  #         luaVersion: "5.1"
  #
  #     - uses: leafo/gh-actions-luarocks@v4
  #
  #     - name: Upload to LuaRocks
  #       env:
  #         LUAROCKS_API_KEY: ${{ secrets.LUAROCKS_API_KEY }}
  #       run: luarocks upload codereview.nvim-v${{ needs.release.outputs.version_tag }}.rockspec --api-key=$LUAROCKS_API_KEY
