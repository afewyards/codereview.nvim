name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: go-semantic-release/action@v1
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  demo-gifs:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ needs.release.outputs.version != '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Install VHS and dependencies
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt-get update
          sudo apt-get install -y ffmpeg vhs
          curl -fsSL -o /tmp/ttyd https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.x86_64
          sudo install /tmp/ttyd /usr/local/bin/ttyd

      - name: Generate demo GIF
        run: vhs demo/ai-review.tape

      - name: Upload demo assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "v${{ needs.release.outputs.version }}" \
            demo/ai-review.gif \
            --clobber

  # Uncomment when ready to publish to LuaRocks:
  #
  # luarocks:
  #   needs: release
  #   runs-on: ubuntu-latest
  #   if: ${{ needs.release.outputs.version != '' }}
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - uses: leafo/gh-actions-lua@v10
  #       with:
  #         luaVersion: "5.1"
  #
  #     - uses: leafo/gh-actions-luarocks@v4
  #
  #     - name: Upload to LuaRocks
  #       env:
  #         LUAROCKS_API_KEY: ${{ secrets.LUAROCKS_API_KEY }}
  #       run: luarocks upload codereview.nvim-v${{ needs.release.outputs.version_tag }}.rockspec --api-key=$LUAROCKS_API_KEY
